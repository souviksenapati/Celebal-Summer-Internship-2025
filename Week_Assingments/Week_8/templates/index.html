<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Document Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
</head>
<body>
    <div class="container" id="dropZone">
        <div class="chat-container" id="chatContainer">
            <div class="welcome-message">
                <div class="welcome-icon">ğŸ¤–</div>
                <h2>RAG Document Chatbot</h2>
                <p>Drop documents anywhere or use the ğŸ“ button to upload</p>
                <div class="uploaded-files" id="uploadedFiles"></div>
            </div>
        </div>
        
        <div class="input-bar">
            <button class="attach-btn" id="attachBtn" title="Attach document">
                ğŸ“
                <input type="file" id="fileInput" accept=".pdf,.txt,.docx" multiple />
            </button>
            <input type="text" id="questionInput" placeholder="Type a message..." />
            <button id="sendBtn" onclick="askQuestion()" title="Send message">â¤</button>
        </div>
        
        <div class="drag-overlay" id="dragOverlay">
            <div class="drag-content">
                <div class="drag-icon">ğŸ“</div>
                <p>Drop your documents here</p>
                <small>Supports PDF, DOCX, TXT files</small>
            </div>
        </div>
    </div>

    <script>
        let uploadedCount = 0;
        
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const dragOverlay = document.getElementById('dragOverlay');
        const chatContainer = document.getElementById('chatContainer');
        const uploadedFiles = document.getElementById('uploadedFiles');
        const attachBtn = document.getElementById('attachBtn');
        
        // Drag and drop functionality for entire container
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragOverlay.style.display = 'flex';
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            if (!dropZone.contains(e.relatedTarget)) {
                dragOverlay.style.display = 'none';
            }
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dragOverlay.style.display = 'none';
            const files = e.dataTransfer.files;
            handleFiles(files);
        });
        
        attachBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                uploadFile(file);
            });
        }
        
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            addMessage('system', `Processing ${file.name}...`);
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(res => res.text())
            .then(data => {
                uploadedCount++;
                addMessage('system', `âœ… ${file.name} processed successfully`);
                addUploadedFile(file.name);
            })
            .catch(err => {
                addMessage('error', `âŒ Failed to process ${file.name}`);
                console.error(err);
            });
        }
        
        function addUploadedFile(filename) {
            const fileTag = document.createElement('span');
            fileTag.className = 'file-tag';
            fileTag.textContent = filename;
            uploadedFiles.appendChild(fileTag);
        }
        
        function addMessage(type, content) {
            // Hide welcome message after first interaction
            const welcomeMsg = document.querySelector('.welcome-message');
            if (welcomeMsg && (type === 'user' || type === 'bot')) {
                welcomeMsg.style.display = 'none';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = type === 'user' ? 'ğŸ‘¤' : type === 'system' ? 'âš™ï¸' : type === 'error' ? 'âŒ' : 'ğŸ¤–';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function askQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            if (!question) return;
            if (uploadedCount === 0) {
                addMessage('error', 'Please upload at least one document first.');
                return;
            }

            addMessage('user', question);
            input.value = '';
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';

            fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question })
            })
            .then(res => res.json())
            .then(data => {
                addMessage('bot', data.response);
            })
            .catch(err => {
                addMessage('error', 'Failed to get response');
                console.error(err);
            })
            .finally(() => {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            });
        }
        
        // Enter key support
        document.getElementById('questionInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') askQuestion();
        });
    </script>
</body>
</html>
